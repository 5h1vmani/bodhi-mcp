#!/bin/bash
# pre-push hook for nucleus
# Validates ALL documentation before pushing

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${YELLOW}ğŸš€ Pre-push: Full validation...${NC}"
echo ""

# Change to repo root
cd "$(git rev-parse --show-toplevel)"

ERRORS=0

# Helper function for cross-platform path normalization
normalize_path() {
    local dir="$1"
    local link="$2"
    python3 -c "import os; print(os.path.normpath(os.path.join('$dir', '$link')))" 2>/dev/null || echo "$dir/$link"
}

# 1. Lint all markdown files
echo "1. Linting all markdown files..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if command -v markdownlint-cli2 &> /dev/null; then
    if ! markdownlint-cli2 2>/dev/null; then
        echo -e "${RED}âŒ Markdown lint failed${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}âœ… Markdown lint passed${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  markdownlint-cli2 not installed. Skipping lint.${NC}"
fi
echo ""

# 2. Check frontmatter on domain docs
echo "2. Checking frontmatter..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
FRONTMATTER_ERRORS=0
while IFS= read -r -d '' file; do
    if [[ "$file" == *"_index.md" ]]; then
        continue
    fi
    if ! head -1 "$file" | grep -q "^---$"; then
        echo -e "${RED}âŒ Missing frontmatter: $file${NC}"
        FRONTMATTER_ERRORS=$((FRONTMATTER_ERRORS + 1))
    fi
done < <(find domains -name "*.md" -type f -print0 2>/dev/null)

if [ $FRONTMATTER_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… All domain docs have frontmatter${NC}"
else
    ERRORS=$((ERRORS + FRONTMATTER_ERRORS))
fi
echo ""

# 3. Check TL;DR sections
echo "3. Checking TL;DR sections..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
TLDR_ERRORS=0
while IFS= read -r -d '' file; do
    if [[ "$file" == *"_index.md" ]]; then
        continue
    fi
    if ! grep -q "^## TL;DR" "$file"; then
        echo -e "${YELLOW}âš ï¸  Missing TL;DR: $file${NC}"
        TLDR_ERRORS=$((TLDR_ERRORS + 1))
    fi
done < <(find domains -name "*.md" -type f -print0 2>/dev/null)

if [ $TLDR_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… All domain docs have TL;DR${NC}"
else
    echo -e "${YELLOW}   ($TLDR_ERRORS docs missing TL;DR - warning only)${NC}"
fi
echo ""

# 4. Check for broken internal links (excluding templates)
echo "4. Checking internal links..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
LINK_ERRORS=0

# Function to extract links outside of code blocks
extract_links_outside_codeblocks() {
    python3 << 'PYTHON_SCRIPT' "$1"
import sys
import re

filepath = sys.argv[1]
with open(filepath, 'r') as f:
    content = f.read()

# Remove fenced code blocks (``` ... ```)
content_no_code = re.sub(r'```[\s\S]*?```', '', content)

# Remove inline code (`...`)
content_no_code = re.sub(r'`[^`]+`', '', content_no_code)

# Find relative links: [text](./path) or [text](../path)
links = re.findall(r'\]\((\.\.?/[^)]+)\)', content_no_code)
for link in links:
    print(link)
PYTHON_SCRIPT
}

while IFS= read -r -d '' file; do
    links=$(extract_links_outside_codeblocks "$file" 2>/dev/null || true)

    for link in $links; do
        link_without_anchor="${link%%#*}"
        dir=$(dirname "$file")
        target=$(normalize_path "$dir" "$link_without_anchor")

        if [ ! -e "$target" ]; then
            echo -e "${RED}âŒ Broken link in $file: $link${NC}"
            LINK_ERRORS=$((LINK_ERRORS + 1))
        fi
    done
done < <(find . -name "*.md" -type f -not -path "./templates/*" -not -path "./node_modules/*" -print0 2>/dev/null)

if [ $LINK_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… No broken internal links${NC}"
else
    ERRORS=$((ERRORS + LINK_ERRORS))
fi
echo ""

# 5. Check required files
echo "5. Checking required files..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
REQUIRED_FILES=(
    "CLAUDE.md"
    "AGENT.md"
    "INDEX.md"
    "README.md"
    "templates/playbook.md"
    "meta/contributing.md"
)

REQUIRED_ERRORS=0
for required in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$required" ]; then
        echo -e "${RED}âŒ Missing required file: $required${NC}"
        REQUIRED_ERRORS=$((REQUIRED_ERRORS + 1))
    fi
done

if [ $REQUIRED_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… All required files present${NC}"
else
    ERRORS=$((ERRORS + REQUIRED_ERRORS))
fi
echo ""

# 6. Check domain _index.md files
echo "6. Checking domain indexes..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
INDEX_ERRORS=0
for domain in domains/*/; do
    if [ ! -f "${domain}_index.md" ]; then
        echo -e "${RED}âŒ Missing _index.md in $domain${NC}"
        INDEX_ERRORS=$((INDEX_ERRORS + 1))
    fi
done

if [ $INDEX_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… All domains have _index.md${NC}"
else
    ERRORS=$((ERRORS + INDEX_ERRORS))
fi
echo ""

# 7. Check Prettier formatting
echo "7. Checking Prettier formatting..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if command -v npx &> /dev/null; then
    if ! npx prettier --check '**/*.md' 2>/dev/null; then
        echo -e "${RED}âŒ Unformatted files detected. Run 'npm run format' first.${NC}"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}âœ… All files properly formatted${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  npx not found. Skipping format check.${NC}"
fi
echo ""

# 8. Check kebab-case naming
echo "8. Checking file naming..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
NAMING_ERRORS=0
while IFS= read -r -d '' file; do
    filename=$(basename "$file")
    if [[ "$filename" == "CLAUDE.md" ]] || [[ "$filename" == "AGENT.md" ]] || [[ "$filename" == "INDEX.md" ]] || [[ "$filename" == "_index.md" ]] || [[ "$filename" == "README.md" ]]; then
        continue
    fi
    if ! echo "$filename" | grep -qE '^[a-z0-9]+(-[a-z0-9]+)*\.md$'; then
        echo -e "${RED}âŒ Invalid filename: $file${NC}"
        NAMING_ERRORS=$((NAMING_ERRORS + 1))
    fi
done < <(find . -name "*.md" -type f -not -path "./node_modules/*" -print0 2>/dev/null)

if [ $NAMING_ERRORS -eq 0 ]; then
    echo -e "${GREEN}âœ… All files follow kebab-case${NC}"
else
    ERRORS=$((ERRORS + NAMING_ERRORS))
fi
echo ""

# Summary
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âŒ Pre-push FAILED: $ERRORS error(s)${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above or use --no-verify to skip.${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… Pre-push PASSED${NC}"
fi
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
exit 0
